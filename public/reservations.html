<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reservations - Simple UI</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 30px auto; padding: 0 16px; }
    h1 { margin-bottom: 6px; }
    small { color: #666; }
    form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 16px 0; }
    input, select, button { padding: 10px; }
    button { cursor: pointer; }
    .full { grid-column: 1 / -1; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 10px 0; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .error { color: #b00020; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Reservations</h1>
  <small>Simple UI for /api/reservations</small>

  <p>
    <a href="/">‚Üê Back to Parking Lots</a>
  </p>

  <h2>Create reservation</h2>
  <form id="resForm">
    <select id="parkingLotId" required></select>
    <input id="customerName" placeholder="Customer name" required />
    <input id="carPlate" placeholder="Car plate" required />
    <input id="startTime" type="datetime-local" required />
    <input id="endTime" type="datetime-local" required />
    <button class="full" type="submit">Create</button>
  </form>

  <div id="msg" class="error"></div>

  <h2>List</h2>
  <div id="list"></div>

  <script>
    const msgEl = document.getElementById('msg');
    const listEl = document.getElementById('list');
    const selectEl = document.getElementById('parkingLotId');

    function toIsoFromLocalInput(value) {
      // datetime-local gives "YYYY-MM-DDTHH:mm"
      // new Date() will treat it as local time; convert to ISO string for server
      const d = new Date(value);
      return d.toISOString();
    }

    async function loadLotsDropdown() {
      const res = await fetch('/api/parking-lots');
      const lots = await res.json();

      selectEl.innerHTML = '';
      lots.forEach((lot) => {
        const opt = document.createElement('option');
        opt.value = lot._id;
        opt.textContent = `${lot.name} (price/hour: ${lot.pricePerHour})`;
        selectEl.appendChild(opt);
      });
    }

    async function loadReservations() {
      msgEl.textContent = '';
      listEl.innerHTML = 'Loading...';

      const res = await fetch('/api/reservations');
      const data = await res.json();

      if (!Array.isArray(data)) {
        listEl.innerHTML = '';
        msgEl.textContent = JSON.stringify(data, null, 2);
        return;
      }

      listEl.innerHTML = '';
      data.forEach((r) => {
        const div = document.createElement('div');
        div.className = 'card';

        const lot = r.parkingLotId;
        const lotText = lot ? `${lot.name} / ${lot.address}` : '(no lot)';

        div.innerHTML = `
          <b>${r.customerName}</b> (${r.carPlate})
          <div>Parking lot: ${lotText}</div>
          <div>Start: ${new Date(r.startTime).toLocaleString()}</div>
          <div>End: ${new Date(r.endTime).toLocaleString()}</div>
          <div>Total price: ${r.totalPrice}</div>
          <div><small>ID: ${r._id}</small></div>
          <div class="row">
            <button data-id="${r._id}" class="deleteBtn">Delete</button>
          </div>
        `;

        listEl.appendChild(div);
      });

      document.querySelectorAll('.deleteBtn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const ok = confirm('Delete this reservation?');
          if (!ok) return;

          const delRes = await fetch(`/api/reservations/${id}`, { method: 'DELETE' });
          if (delRes.status !== 204) {
            const err = await delRes.json().catch(() => ({}));
            msgEl.textContent = JSON.stringify(err, null, 2);
          }

          loadReservations();
        });
      });
    }

    document.getElementById('resForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      msgEl.textContent = '';

      const body = {
        parkingLotId: selectEl.value,
        customerName: document.getElementById('customerName').value,
        carPlate: document.getElementById('carPlate').value,
        startTime: toIsoFromLocalInput(document.getElementById('startTime').value),
        endTime: toIsoFromLocalInput(document.getElementById('endTime').value)
      };

      const res = await fetch('/api/reservations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        msgEl.textContent = JSON.stringify(err, null, 2);
        return;
      }

      e.target.reset();
      loadReservations();
    });

    (async function init() {
      await loadLotsDropdown();
      await loadReservations();
    })();
  </script>
</body>
</html>
